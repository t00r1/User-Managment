# Проект: User Managment 

## ВАЖНО
Все необходимые данные (переменные окружения и данные для подключения к БД) можно найти в папке "Начинающий Node.js-разработчик" (Папку можно получить по ссылке на Яндекс Диск указанной в форме), в том числе и CA (читайте ниже).

## Описание 
REST API для управления пользователями: регистрация, авторизация, получение данных, блокировка пользователей.
Для аутентификации используется механизм с использованием JWT-токенов.

# Стек
- JavaScript 
- Node.js
- Express.js
- Mongoose
- MongoDB 
- dotenv для переменных окружения 
- JWT для аутентификации 
- bcrypt для хеширования пароля 

## Архитектура
```
src/
|———— controllers/ 
|      |———— auth-controller.js # Контроллер для обработки запросов связанные с пользовательской аутентификацией (регистрация и авторизация) 
|      |____ user-controller.js # Контроллер для обработки запросов связанные с пользователями 
|
|———— middleware/
|     |_____ auth-middleware.js (loggedIn) # Проверка JWT-токена и ролей
|
|———— models/
|     |_____ User.js # Схема пользователя
|
|———— routes/
|     |———— auth-routes.js # Эндпоинты регистрации и авторизации 
|     |____ user-routes.js # Эндпоинты пользователей 
|
|———— utils/
|     |____ helpers.js # Хелперы
|
|———— db/
|     |____ db.js # Подключение к БД
|
|———— app.js # Точка входа 
|———— config.js # Конфиг
|———— .env # Переменные окружения (PORT, SECRET_KEY)
|———— .credentials.development.json # Строка подключение к БД
|———— package.json # Зависимости и скрипты 
|———— root.crt # CA для подключения к БД


```

## Основные компоненты 

## 0. Модель пользователя User
- **Поля**
`fullName` -> String
`email` -> String
`password` -> String (хеш)
`role` -> String (user/admin)
`isActive` -> Boolean 

## 1. Эндпоинты 
- `POST /api/auth/register`: Регистрация пользователя
- `POST /api/auth/login`: Авторизация пользователя
- `GET /admin/users`: Получение списка пользователей (только для админов)
- `GET /api/users/:userID`: Получение пользователя 
- `PATCH /api/users/:userID/block`: Блокировка пользователя

## 2. Middleware 
- `loggedIn([roles])`: Проверка JWT-токена и роли пользователя

## 3. Хелперы 
- `hashedPassword(password, salt)`: Хеширование пароля 
- `generateJWT(id, email, role)`: Генерация JWT-токена 
- `comparePassword(password, hashedPassword)`: Проверка пароля
- `verifyUserAccess()`: Верификация пользователя, проверка на существование и прав пользователя (над которым совершаются определенные действия)

## 4. Установка 

1. Установка зависимостей
```npm install```
2. Настройка `.env`
```
PORT=port
SECRET_KEY=jwt_секрет
```
3. MongoDB (Кластер на YandexCloud)
База данных запущена. 
Строка подключения указывается в .credentials.development.json в качестве значения "connectionString" в "mongoDB". К всему прочему, для подключения к БД необходимо добавить CA (root.crt) в корневую директорию проекта.
4. Запуск сервера
```npm start```

## 5. Тестирование
- Для проверки эндпоинтов можно воспользоваться программой Postman
- При регистрации передать следующие параметры: 
`fullName`: Полное имя пользователя
`email`: Email пользователя (уникальное значение)
`dayOfBirth`: День рождения пользователя. Передается в формате: "гггг-мм-дд". Например: "2001-01-01"
`password`: Пароль пользователя
`role`: Роль пользователя: "user" или "admin". Роль по умолчанию: "user"
`isActive`: Статус пользователя: "активный" или "не активный". Данный параметр не нужно указывать, при регистрации по умолчанию пользователь получает статус "активный".

## 6. Дополнительно 
- Проверка статуса пользователя осуществляется только при авторизации
- JWT-токен выдается при авторизации пользователя 
- Жизнь JWT-токена: 3 часа 
